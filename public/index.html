<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>12球場比賽管理</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .court { border: 2px solid #333; border-radius: 8px; padding: 10px; }
    .player-row {
      display: flex;
      align-items: center;
      margin-top: 6px;
    }
    .player-row input[type="text"] {
      font-size: 14px;
      padding: 4px;
    }
    .name-input {
      flex: 1;
      margin-right: 6px;
    }
    .score-input {
      width: 50px;
      text-align: center;
    }
    textarea {
      width: 100%;
      font-size: 14px;
      margin-top: 10px;
      resize: vertical;
    }
    select {
      width: 100%;
      margin-top: 8px;
      font-size: 14px;
      padding: 4px;
    }
    button {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 14px;
      display: block;
      width: 100%;
    }
  </style>
</head>
<body>

<h1>12球場比賽管理</h1>
<div id="courts-container" class="grid"></div>

<script>
  const API_BASE = "http://192.168.x.x:3000"; // 請改成你的伺服器 IP
  const PASSWORD = "1234"; // 可自訂管理密碼
  let isUnlocked = false;
  let courtsCache = [];

  async function loadCourts() {
    try {
      const res = await fetch(`${API_BASE}/courts`);
      const courtsData = await res.json();
      courtsCache = courtsData;
      renderCourts(courtsData);
    } catch (e) {
      alert("無法讀取球場資料");
    }
  }

  function renderCourts(data) {
    const container = document.getElementById("courts-container");
    container.innerHTML = "";

    data.forEach((court, i) => {
      const div = document.createElement("div");
      div.className = "court";
      div.innerHTML = `
        <h3 style="text-align:center;">球場 ${i + 1}</h3>

        <div class="player-row">
          <input type="text" id="player1-${i}" value="${court.player1}" placeholder="選手1姓名" class="name-input" ${isUnlocked ? "" : "disabled"} />
          <input type="text" id="score1-${i}" value="${court.score1}" class="score-input" placeholder="比分" ${isUnlocked ? "" : "disabled"} />
        </div>

        <div class="player-row">
          <input type="text" id="player2-${i}" value="${court.player2}" placeholder="選手2姓名" class="name-input" ${isUnlocked ? "" : "disabled"} />
          <input type="text" id="score2-${i}" value="${court.score2}" class="score-input" placeholder="比分" ${isUnlocked ? "" : "disabled"} />
        </div>

        <textarea id="nextPlayers-${i}" placeholder="下一場比賽選手名單" rows="3" ${isUnlocked ? "" : "disabled"}>${court.nextPlayers}</textarea>

        <select id="status-${i}" ${isUnlocked ? "" : "disabled"}>
          <option value="尚未開始" ${court.status === "尚未開始" ? "selected" : ""}>尚未開始</option>
          <option value="進行中" ${court.status === "進行中" ? "selected" : ""}>進行中</option>
          <option value="已結束" ${court.status === "已結束" ? "selected" : ""}>已結束</option>
        </select>

        ${isUnlocked
          ? `<button onclick="saveCourt(${i})">儲存 球場 ${i + 1}</button>`
          : ""
        }
      `;
      container.appendChild(div);
    });
  }

  async function saveCourt(index) {
    const courtData = {
      player1: document.getElementById(`player1-${index}`).value,
      score1: document.getElementById(`score1-${index}`).value,
      player2: document.getElementById(`player2-${index}`).value,
      score2: document.getElementById(`score2-${index}`).value,
      nextPlayers: document.getElementById(`nextPlayers-${index}`).value,
      status: document.getElementById(`status-${index}`).value,
    };

    try {
      const res = await fetch(`${API_BASE}/courts/${index}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(courtData),
      });
      const result = await res.json();
      alert(result.message);
    } catch (e) {
      alert("儲存失敗");
    }
  }

  setInterval(() => {
    if (!isUnlocked) return;

    for (let i = 0; i < 12; i++) {
      const courtData = {
        player1: document.getElementById(`player1-${i}`).value,
        score1: document.getElementById(`score1-${i}`).value,
        player2: document.getElementById(`player2-${i}`).value,
        score2: document.getElementById(`score2-${i}`).value,
        nextPlayers: document.getElementById(`nextPlayers-${i}`).value,
        status: document.getElementById(`status-${i}`).value,
      };

      if (JSON.stringify(courtData) !== JSON.stringify(courtsCache[i])) {
        courtsCache[i] = courtData;
        fetch(`${API_BASE}/courts/${i}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(courtData),
        });
        console.log(`自動儲存 球場 ${i + 1}`);
      }
    }
  }, 30000); // 每 30 秒

  window.onload = async function () {
    const inputPassword = prompt("請輸入管理密碼（可跳過僅查看）");
    if (inputPassword === PASSWORD) {
      isUnlocked = true;
    } else {
      alert("密碼錯誤，進入唯讀模式");
    }
    await loadCourts();
  };
</script>

</body>
</html>
